<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Ropa Infantil - Tu Empresa</title>
    <!-- Carga de Tailwind CSS para estilos rápidos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
        Para usar la fuente "Glacial Indifference":
        Necesitarás importar esta fuente. No está disponible en Google Fonts.
        Puedes descargarla y usar @font-face en tu CSS, o usar un CDN si encuentras uno.
        Ejemplo (si tienes los archivos de la fuente):
        @font-face {
            font-family: 'Glacial Indifference';
            src: url('path/to/GlacialIndifference-Regular.woff2') format('woff2'),
                 url('path/to/GlacialIndifference-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Glacial Indifference';
            src: url('path/to/GlacialIndifference-Bold.woff2') format('woff2'),
                 url('path/to/GlacialIndifference-Bold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
        }
        */
        /* Establece Glacial Indifference como fuente principal para toda la app, con sans-serif como respaldo */
        body {
            font-family: 'Glacial Indifference', sans-serif;
            background-color: #f0f4f8; /* Un color de fondo suave */
        }
        .container {
            max-width: 1000px; /* Aumentado el ancho para la tabla */
        }
        /* Estilos para mensajes de estado */
        .message-box {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            display: none; /* Oculto por defecto */
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* Estilos para la tabla */
        .product-table th, .product-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .product-table th {
            background-color: #edf2f7;
            font-weight: 600;
            color: #4a5568;
        }
        .product-table input[type="text"],
        .product-table input[type="number"],
        .product-table select,
        .product-table textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }
        .product-table tfoot td {
            font-weight: bold;
            background-color: #e2e8f0;
            border-top: 2px solid #a0aec0;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white p-8 rounded-xl shadow-lg w-full">
        <!-- Título Principal Actualizado -->
        <h1 class="text-4xl font-bold text-[#253754] text-center mb-8">Pedido Creaciones Toñitos</h1>
        <p class="text-center text-gray-600 mb-6">Ingresa los detalles del pedido a continuación.</p>

        <form id="orderForm" class="space-y-6">
            <!-- Sección de Fecha del Pedido (con tamaño de fuente ajustado y colores nuevos) -->
            <div class="bg-[#e6f0f7] p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-[#253754] mb-4">Fecha del Pedido</h2>
                <div>
                    <label for="orderDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Pedido</label>
                    <input type="date" id="orderDate" name="orderDate" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm"> <!-- sm:text-sm para 2 puntos menos -->
                </div>
            </div>

            <!-- Sección de Información del Cliente (con colores nuevos) -->
            <div class="bg-[#e6f0f7] p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-[#253754] mb-4">Datos del Cliente</h2>
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                    <input type="text" id="customerName" name="customerName" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                </div>
                <div>
                    <label for="customerNit" class="block text-sm font-medium text-gray-700 mb-1 mt-4">NIT</label>
                    <input type="text" id="customerNit" name="customerNit"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                </div>
                <div>
                    <label for="customerAddress" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Dirección</label>
                    <input type="text" id="customerAddress" name="customerAddress" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                </div>
                <div>
                    <label for="customerCity" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Ciudad</label>
                    <input type="text" id="customerCity" name="customerCity" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                </div>
                <div>
                    <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Teléfono de Contacto</label>
                    <input type="tel" id="customerPhone" name="customerPhone" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                </div>
                <div>
                    <label for="customerEmail" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Correo Electrónico (Opcional)</label>
                    <input type="email" id="customerEmail" name="customerEmail"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                </div>
                <div>
                    <label for="sellerName" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Nombre Vendedor</label>
                    <input type="text" id="sellerName" name="sellerName" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base">
                </div>
            </div>

            <!-- Sección de Detalles del Pedido con Tabla (con colores nuevos) -->
            <div class="bg-[#e6f0f7] p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-[#253754] mb-4">Detalles del Pedido</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full product-table">
                        <thead>
                            <tr>
                                <th class="w-1/6">Referencia</th>
                                <th class="w-2/6">Nombre del Producto</th>
                                <th class="w-1/6">Precio Venta</th>
                                <th class="w-1/12">Cantidad</th>
                                <th class="w-1/12">Total</th>
                                <th class="w-1/6">Notas Adicionales</th>
                                <th class="w-auto"></th> <!-- Columna para el botón de eliminar -->
                            </tr>
                        </thead>
                        <tbody id="productRows">
                            <!-- Filas de productos se añadirán aquí dinámicamente -->
                        </tbody>
                        <tfoot class="bg-gray-200">
                            <tr>
                                <td colspan="4" class="text-right">Total General:</td>
                                <td id="grandTotal" class="text-left">0.00</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="flex justify-end mt-4">
                    <button type="button" id="addProductBtn"
                            class="px-6 py-2 bg-[#6b7280] text-white font-bold rounded-full shadow-lg hover:bg-[#5a606b] focus:outline-none focus:ring-2 focus:ring-[#6b7280] focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                        Añadir Producto
                    </button>
                </div>
            </div>

            <!-- Botón de Envío Unificado -->
            <div class="flex justify-center mt-6">
                <button type="submit"
                        class="w-full sm:w-auto px-8 py-3 bg-[#253754] text-white font-bold rounded-full shadow-lg hover:bg-[#1a2b3c] focus:outline-none focus:ring-2 focus:ring-[#253754] focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                    Enviar
                </button>
            </div>
        </form>

        <!-- Contenedor para mensajes de estado -->
        <div id="messageContainer" class="message-box"></div>
    </div>

    <script>
        // Array para almacenar los productos obtenidos de la Netlify Function
        let products = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const orderForm = document.getElementById('orderForm');
            const productRowsContainer = document.getElementById('productRows');
            const addProductBtn = document.getElementById('addProductBtn');
            const messageContainer = document.getElementById('messageContainer');
            const grandTotalDisplay = document.getElementById('grandTotal');

            // --- Cargar productos desde la Netlify Function al iniciar la página ---
            try {
                showMessage('Cargando productos...', 'info');
                const response = await fetch('/.netlify/functions/get-products'); // Llama a tu nueva función
                const data = await response.json();

                if (response.ok && data.products) {
                    products = data.products; // Asigna los productos cargados al array global
                    showMessage('Productos cargados con éxito.', 'success');
                    addProductRow(); // Añadir la primera fila de producto una vez que los productos estén cargados
                } else {
                    throw new Error(data.error || 'No se pudieron cargar los productos.');
                }
            } catch (error) {
                console.error('Error al cargar productos:', error);
                showMessage(`Error al cargar productos: ${error.message}. La lista estará vacía.`, 'error');
                // Si hay un error, puedes añadir una fila vacía o deshabilitar la adición de productos
                addProductRow(); // Añadir una fila vacía si no se cargan productos
            }

            // Función para mostrar mensajes de estado
            function showMessage(message, type) {
                messageContainer.textContent = message;
                messageContainer.className = `message-box ${type}`; // Añade la clase de tipo (success/error/info)
                messageContainer.style.display = 'block'; // Muestra el contenedor
                // Oculta el mensaje después de 5 segundos
                setTimeout(() => {
                    messageContainer.style.display = 'none';
                }, 5000);
            }

            // Función para calcular el total de una fila de producto
            function calculateRowTotal(row) {
                const priceInput = row.querySelector('.product-price-input');
                const quantityInput = row.querySelector('input[type="number"]');
                const totalInput = row.querySelector('.product-total-input');

                const price = parseFloat(priceInput.value) || 0;
                const quantity = parseInt(quantityInput.value) || 0;
                const total = price * quantity;

                totalInput.value = total.toFixed(2); // Muestra el total con 2 decimales
                updateGrandTotal(); // Actualiza el total general cada vez que cambia un total de fila
            }

            // Función para actualizar el total general
            function updateGrandTotal() {
                let grandTotal = 0;
                const rows = productRowsContainer.querySelectorAll('tr');
                rows.forEach(row => {
                    const totalInput = row.querySelector('.product-total-input');
                    grandTotal += parseFloat(totalInput.value) || 0;
                });
                grandTotalDisplay.textContent = grandTotal.toFixed(2); // Muestra el total general
            }

            // Función para añadir una nueva fila de producto a la tabla
            function addProductRow() {
                const newRow = document.createElement('tr');
                const rowIndex = productRowsContainer.children.length; // Índice para identificar la fila

                newRow.innerHTML = `
                    <td>
                        <select name="productReference_${rowIndex}" class="product-reference-select" required>
                            <option value="">Selecciona una referencia</option>
                            ${products.map(p => `<option value="${p.reference}">${p.reference} - ${p.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="productName_${rowIndex}" class="product-name-input" readonly required>
                    </td>
                    <td>
                        <input type="text" name="productPrice_${rowIndex}" class="product-price-input" readonly required>
                    </td>
                    <td>
                        <input type="number" name="quantity_${rowIndex}" value="1" min="1" required>
                    </td>
                    <td>
                        <input type="text" name="productTotal_${rowIndex}" class="product-total-input" readonly>
                    </td>
                    <td>
                        <textarea name="itemNotes_${rowIndex}" rows="1"></textarea>
                    </td>
                    <td>
                        <button type="button" class="remove-product-btn px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600">X</button>
                    </td>
                `;
                productRowsContainer.appendChild(newRow);

                // Añadir event listeners para la nueva fila
                const selectElement = newRow.querySelector('.product-reference-select');
                const quantityInput = newRow.querySelector('input[type="number"]');
                const removeButton = newRow.querySelector('.remove-product-btn');

                selectElement.addEventListener('change', (event) => {
                    const selectedReference = event.target.value;
                    const selectedProduct = products.find(p => p.reference === selectedReference);
                    const productNameInput = newRow.querySelector('.product-name-input');
                    const productPriceInput = newRow.querySelector('.product-price-input');

                    if (selectedProduct) {
                        productNameInput.value = selectedProduct.name;
                        productPriceInput.value = selectedProduct.price.toFixed(2); // Formatear a 2 decimales
                    } else {
                        productNameInput.value = '';
                        productPriceInput.value = '';
                    }
                    calculateRowTotal(newRow); // Recalcular el total de la fila al cambiar la referencia
                });

                quantityInput.addEventListener('input', () => {
                    calculateRowTotal(newRow); // Recalcular el total de la fila al cambiar la cantidad
                });

                removeButton.addEventListener('click', () => {
                    newRow.remove();
                    updateGrandTotal(); // Actualizar el total general al eliminar una fila
                });

                // Calcular el total inicial para la nueva fila
                calculateRowTotal(newRow);
            }

            // Event listener para el botón "Añadir Producto"
            addProductBtn.addEventListener('click', addProductRow);

            // Función para obtener todos los datos del formulario
            function getOrderData() {
                // Recolectar los datos del cliente
                const customerData = {
                    orderDate: document.getElementById('orderDate').value,
                    customerName: document.getElementById('customerName').value,
                    customerNit: document.getElementById('customerNit').value,
                    customerAddress: document.getElementById('customerAddress').value,
                    customerCity: document.getElementById('customerCity').value,
                    customerPhone: document.getElementById('customerPhone').value,
                    customerEmail: document.getElementById('customerEmail').value,
                    sellerName: document.getElementById('sellerName').value
                };

                // Recolectar los datos de los productos de la tabla
                const productItems = [];
                const rows = productRowsContainer.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    const reference = row.querySelector(`[name="productReference_${index}"]`).value;
                    const name = row.querySelector(`[name="productName_${index}"]`).value;
                    const price = parseFloat(row.querySelector(`[name="productPrice_${index}"]`).value);
                    const quantity = parseInt(row.querySelector(`[name="quantity_${index}"]`).value);
                    const total = parseFloat(row.querySelector(`[name="productTotal_${index}"]`).value);
                    const notes = row.querySelector(`[name="itemNotes_${index}"]`).value;

                    if (reference) {
                        productItems.push({
                            reference,
                            name,
                            price,
                            quantity,
                            total,
                            notes
                        });
                    }
                });

                return {
                    customer: customerData,
                    products: productItems,
                    grandTotal: parseFloat(grandTotalDisplay.textContent)
                };
            }

            // Manejar el envío del formulario (unificado)
            orderForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Evita el envío por defecto del formulario

                const fullOrderData = getOrderData();

                if (fullOrderData.products.length === 0) {
                    showMessage('Por favor, añade al menos un producto al pedido.', 'error');
                    return;
                }

                // Paso 1: Generar nueva hoja y enviar por WhatsApp
                showMessage('Generando hoja de pedido y preparando mensaje de WhatsApp...', 'info');
                const generateSheetFunctionUrl = '/.netlify/functions/generate-order-sheet'; // URL de tu función

                let sheetUrl = '';
                try {
                    const response = await fetch(generateSheetFunctionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullOrderData),
                    });
                    const result = await response.json();

                    if (response.ok && result.sheetUrl) {
                        sheetUrl = result.sheetUrl;
                        showMessage('Hoja de pedido generada. Preparando mensaje de WhatsApp.', 'success');

                        // Construir el mensaje de WhatsApp con la URL de la hoja
                        let whatsappMessage = `*Nuevo Pedido de Ropa Infantil*\n\n`;
                        whatsappMessage += `*Fecha del Pedido:* ${fullOrderData.customer.orderDate}\n`;
                        whatsappMessage += `*Vendedor:* ${fullOrderData.customer.sellerName}\n\n`;

                        whatsappMessage += `*Datos del Cliente:*\n`;
                        whatsappMessage += `Nombre: ${fullOrderData.customer.customerName}\n`;
                        if (fullOrderData.customer.customerNit) {
                            whatsappMessage += `NIT: ${fullOrderData.customer.customerNit}\n`;
                        }
                        whatsappMessage += `Dirección: ${fullOrderData.customer.customerAddress}\n`;
                        whatsappMessage += `Ciudad: ${fullOrderData.customer.customerCity}\n`;
                        whatsappMessage += `Teléfono: ${fullOrderData.customer.customerPhone}\n`;
                        if (fullOrderData.customer.customerEmail) {
                            whatsappMessage += `Email: ${fullOrderData.customer.customerEmail}\n`;
                        }
                        whatsappMessage += `\n`;

                        whatsappMessage += `*Detalles de Productos:*\n`;
                        fullOrderData.products.forEach(product => {
                            whatsappMessage += `\n- Ref: ${product.reference}\n`;
                            whatsappMessage += `  Producto: ${product.name}\n`;
                            whatsappMessage += `  Precio U.: $${product.price.toFixed(2)}\n`;
                            whatsappMessage += `  Cantidad: ${product.quantity}\n`;
                            whatsappMessage += `  Total Item: $${product.total.toFixed(2)}\n`;
                            if (product.notes) {
                                whatsappMessage += `  Notas: ${product.notes}\n`;
                            }
                        });

                        whatsappMessage += `\n*Total General del Pedido: $${fullOrderData.grandTotal.toFixed(2)}*\n`;
                        whatsappMessage += `\n*Ver detalles completos en Google Sheet:*\n${sheetUrl}\n`; // Añade la URL de la hoja
                        whatsappMessage += `\n¡Gracias!`;

                        const encodedMessage = encodeURIComponent(whatsappMessage);
                        const phoneNumber = ''; // Dejar vacío para que el usuario elija el contacto

                        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                        window.open(whatsappUrl, '_blank');

                    } else {
                        throw new Error(result.error || 'No se pudo generar la URL de la hoja.');
                    }

                } catch (error) {
                    console.error('Error al generar la hoja de pedido o enviar por WhatsApp:', error);
                    showMessage(`Error: ${error.message}. No se pudo generar la hoja o enviar por WhatsApp.`, 'error');
                    // Si falla la primera parte, no intentamos la segunda para evitar datos inconsistentes
                    return;
                }

                // Paso 2: Registrar pedido en la hoja existente
                showMessage('Registrando pedido en la hoja existente...', 'info');
                const addOrderFunctionUrl = '/.netlify/functions/add-order-to-sheet'; // URL de tu función para la hoja existente

                try {
                    const response = await fetch(addOrderFunctionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(fullOrderData),
                    });

                    if (response.ok) {
                        showMessage('Pedido registrado con éxito en la hoja existente y procesado para WhatsApp.', 'success');
                        orderForm.reset();
                        productRowsContainer.innerHTML = '';
                        // Solo añade la primera fila si hay productos cargados
                        if (products.length > 0) {
                            addProductRow();
                        } else {
                            showMessage('No hay productos cargados para añadir una nueva fila.', 'info');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Error al registrar el pedido en la hoja existente:', errorText);
                        showMessage(`Error al registrar el pedido en la hoja existente: ${errorText || 'Error desconocido'}.`, 'error');
                    }
                } catch (error) {
                    console.error('Error de red o de la función (registro en hoja existente):', error);
                    showMessage('Hubo un problema de conexión o del sistema al registrar en la hoja existente. Inténtalo de nuevo.', 'error');
                }
            });
        });
    </script>
</body>
</html>
